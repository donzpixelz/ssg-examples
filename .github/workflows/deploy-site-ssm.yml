name: deploy-site-ssm

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::953331331353:role/GitHubOIDC-ssg-examples
          aws-region: us-east-2

      - name: Who am I?
        run: aws sts get-caller-identity

      - name: Resolve bucket
        run: |
          set -euo pipefail
          SECRET_VAL="${{ secrets.DEPLOY_S3_BUCKET }}"
          if [ -n "$SECRET_VAL" ]; then
            echo "BUCKET=$SECRET_VAL" >> "$GITHUB_ENV"
          else
            echo "BUCKET=ssg-examples-deploy-953331331353-us-east-2" >> "$GITHUB_ENV"
          fi
          echo "AWS_REGION=us-east-2" >> "$GITHUB_ENV"

      - name: Ensure bucket exists
        run: |
          set -euo pipefail
          if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
            echo "Bucket exists: $BUCKET"
          else
            echo "Creating bucket: $BUCKET in $AWS_REGION"
            if [ "$AWS_REGION" = "us-east-1" ]; then
              aws s3api create-bucket --bucket "$BUCKET" || true
            else
              aws s3api create-bucket --bucket "$BUCKET" \
                --create-bucket-configuration LocationConstraint="$AWS_REGION" || true
            fi
            aws s3api head-bucket --bucket "$BUCKET" >/dev/null 2>&1 || { echo "❌ Bucket ensure failed"; exit 1; }
            aws s3api put-bucket-versioning --bucket "$BUCKET" --versioning-configuration Status=Enabled || true
          fi

      - name: Package app
        run: tar -czf app.tgz -C app .

      - name: Upload to S3 and presign
        run: |
          set -euo pipefail
          KEY_PREFIX="examples/artifacts/${GITHUB_SHA}"
          aws s3 cp app.tgz "s3://${BUCKET}/${KEY_PREFIX}/app.tgz" --region "$AWS_REGION" --acl bucket-owner-full-control
          aws s3 cp run.sh  "s3://${BUCKET}/${KEY_PREFIX}/run.sh"  --region "$AWS_REGION" --acl bucket-owner-full-control
          echo "APP_URL=$(aws s3 presign s3://${BUCKET}/${KEY_PREFIX}/app.tgz --region $AWS_REGION --expires-in 3600)" >> $GITHUB_ENV
          echo "RUN_URL=$(aws s3 presign s3://${BUCKET}/${KEY_PREFIX}/run.sh  --region $AWS_REGION --expires-in 3600)" >> $GITHUB_ENV

      - name: Resolve SSM target instances
        id: targets
        run: |
          set -euo pipefail
          pat='^(i-[a-f0-9]{8}|i-[a-f0-9]{17}|mi-[a-z0-9]{17})$'
          from_secret="${{ secrets.SSM_INSTANCE_ID }}"
          if [ -n "$from_secret" ] && [[ "$from_secret" =~ $pat ]]; then
            ids="$from_secret"
            echo "Using SSM_INSTANCE_ID secret: $ids"
          else
            echo "Secret missing/invalid. Trying by Name tag: ssg-examples"
            ids=$(aws ec2 describe-instances --region "$AWS_REGION" \
                  --filters "Name=tag:Name,Values=ssg-examples" "Name=instance-state-name,Values=running" \
                  --query 'Reservations[].Instances[].InstanceId' --output text | tr '\t' ' ' | xargs || true)
            if [ -z "$ids" ]; then
              echo "No running instances found by tag. Trying public IP: 18.220.33.0"
              ids=$(aws ec2 describe-instances --region "$AWS_REGION" \
                    --filters "Name=ip-address,Values=18.220.33.0" "Name=instance-state-name,Values=running" \
                    --query 'Reservations[].Instances[].InstanceId' --output text | tr '\t' ' ' | xargs || true)
            fi
          fi

          if [ -z "$ids" ]; then
            echo "❌ Could not resolve any instance IDs"
            exit 12
          fi

          json_array="[]"
          for iid in $ids; do
            if [[ "$iid" =~ $pat ]]; then
              json_array=$(jq --arg v "$iid" '. + [ $v ]' <<<"$json_array")
            fi
          done
          if [ "$json_array" = "[]" ]; then
            echo "❌ No valid instance IDs after validation."
            exit 13
          fi

          echo "INSTANCE_IDS_JSON=$json_array" >> "$GITHUB_ENV"
          echo "INSTANCE_IDS=$ids" >> "$GITHUB_ENV"
          echo "Resolved instances: $ids"

      - name: SSM run on EC2
        run: |
          set -euo pipefail
          cat > payload.json <<JSON
          {
            "DocumentName": "AWS-RunShellScript",
            "InstanceIds": ${INSTANCE_IDS_JSON},
            "Parameters": {
              "commands": [
                "set -euo pipefail",
                "curl -fsSL -o /tmp/run.sh ${RUN_URL}",
                "chmod +x /tmp/run.sh",
                "/tmp/run.sh ${APP_URL}"
              ]
            }
          }
          JSON
          aws ssm send-command --cli-input-json file://payload.json --region "$AWS_REGION" >/dev/null
          echo "SSM dispatched to: $INSTANCE_IDS"

      - name: Done
        run: |
          echo "Deployed OK. Opening Actions page..."
          echo "https://github.com/donzpixelz/ssg-examples/actions"
