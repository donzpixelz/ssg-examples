name: deploy-site-ssm

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-2
      DEPLOY_S3_BUCKET: ${{ secrets.DEPLOY_S3_BUCKET }}
      SSM_INSTANCE_ID: ${{ secrets.SSM_INSTANCE_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Package app
        run: |
          set -euo pipefail
          tar -czf app.tgz -C app .

      - name: Upload to S3 and presign
        run: |
          set -euo pipefail
          KEY_PREFIX="examples/artifacts/${GITHUB_SHA}"
          aws s3 cp app.tgz "s3://${DEPLOY_S3_BUCKET}/${KEY_PREFIX}/app.tgz" --region "$AWS_REGION"
          aws s3 cp run.sh  "s3://${DEPLOY_S3_BUCKET}/${KEY_PREFIX}/run.sh"  --region "$AWS_REGION"
          echo "APP_URL=$(aws s3 presign s3://${DEPLOY_S3_BUCKET}/${KEY_PREFIX}/app.tgz --region $AWS_REGION --expires-in 3600)" >> $GITHUB_ENV
          echo "RUN_URL=$(aws s3 presign s3://${DEPLOY_S3_BUCKET}/${KEY_PREFIX}/run.sh  --region $AWS_REGION --expires-in 3600)" >> $GITHUB_ENV

      - name: SSM run on EC2
        run: |
          set -euo pipefail
          cat > payload.json <<JSON
          {
            "DocumentName": "AWS-RunShellScript",
            "InstanceIds": ["${SSM_INSTANCE_ID}"],
            "Parameters": {
              "commands": [
                "set -euo pipefail",
                "curl -fsSL -o /tmp/run.sh ${RUN_URL}",
                "chmod +x /tmp/run.sh",
                "/tmp/run.sh ${APP_URL}"
              ]
            }
          }
          JSON
          aws ssm send-command --cli-input-json file://payload.json --region "$AWS_REGION" >/dev/null

      - name: Done
        run: echo "Dispatched deploy via SSM."
