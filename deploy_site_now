#!/usr/bin/env bash
# deploy_site_now — commit/push to trigger CI/SSM deploy. Returns to prompt.

set -euo pipefail

REPO_ROOT="$(git rev-parse --show-toplevel 2>/dev/null || pwd)"
cd "$REPO_ROOT"

MSG="${1:-Deploy site}"
BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo main)"

echo "▶ Staging deploy paths..."
git add -A app/ nginx/ .github/workflows/deploy-site-ssm.yml || true

if git diff --cached --quiet; then
  echo "ℹ️ No staged changes; creating an empty commit to trigger CI."
  git commit --allow-empty -m "$MSG"
else
  echo "▶ Committing changes..."
  git commit -m "$MSG"
fi

echo "▶ Pushing to origin/${BRANCH}..."
git push origin "$BRANCH"

ACTIONS_URL="https://github.com/donzpixelz/ssg-examples/actions/workflows/deploy-site-ssm.yml"

# Optional: set ACTIONS_OPEN=1 in your environment to auto-open the workflow page.
if [ "${ACTIONS_OPEN:-0}" = "1" ] || [ "${ACTIONS_OPEN:-0}" = "true" ] || [ "${ACTIONS_OPEN:-0}" = "yes" ]; then
  if command -v open >/dev/null 2>&1; then
    open "$ACTIONS_URL" || true
  elif command -v xdg-open >/dev/null 2>&1; then
    xdg-open "$ACTIONS_URL" || true
  fi
fi

echo "✅ Pushed. CI should start shortly."
echo "Done."
