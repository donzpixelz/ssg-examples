#!/usr/bin/env bash
# Full, copy-pasteable Bash file
# Safe to run (will NOT auto-close your terminal)
# File: deploy_site_now

set -euo pipefail
MSG="${1:-site: update}"

# --- go to repo root ---
ROOT="$(git rev-parse --show-toplevel 2>/dev/null || true)"
[ -n "$ROOT" ] || { echo "âŒ Not inside a git repository."; exit 1; }
cd "$ROOT"

# --- current branch ---
CURBR="$(git branch --show-current 2>/dev/null || true)"
[ -n "$CURBR" ] || { echo "âŒ Cannot determine current branch."; exit 1; }

# --- stage, commit (if any), sync, push ---
git add -A
if ! git diff --cached --quiet; then
  git commit -m "$MSG"
fi
git fetch origin
git pull --rebase origin "$CURBR"
git push -u origin "$CURBR"

# --- trigger GitHub Actions workflow (no inputs) ---
WORKFLOW_FILE="deploy-site-ssm.yml"
if command -v gh >/dev/null 2>&1; then
  gh workflow run "$WORKFLOW_FILE" --ref "$CURBR" || true
fi

# --- ALWAYS open the exact Actions tab for this repo ---
ACTIONS_URL="https://github.com/donzpixelz/ssg-examples/actions"
# Prefer AppleScript (reliable from IDE terminals), then macOS open, then xdg-open
if command -v osascript >/dev/null 2>&1; then
  osascript -e 'open location "'"$ACTIONS_URL"'"' || true
elif [ -x /usr/bin/open ]; then
  /usr/bin/open "$ACTIONS_URL" || true
elif command -v xdg-open >/dev/null 2>&1; then
  xdg-open "$ACTIONS_URL" || true
fi
echo "ğŸŒ Actions: $ACTIONS_URL"

echo "âœ… Done."
# âœ… Done: full script above
